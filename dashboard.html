<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Staff - Restaurant</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f4f4;
      padding: 20px;
      margin: 0;
    }
    .header {
      text-align: center;
      color: #5d4037;
      margin-bottom: 20px;
      padding-top: 30px;
    }
    .stats {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stat-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      min-width: 200px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #8b5e3c;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      justify-content: center;
    }
    .tab-btn {
      padding: 10px 20px;
      background: #e0d6cc;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
    }
    .tab-btn.active {
      background: #5d4037;
      color: white;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .order-card {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .order-table {
      font-weight: bold;
      color: #d32f2f;
      font-size: 1.1rem;
    }
    .order-items {
      margin: 10px 0;
      font-size: 0.95rem;
      color: #555;
    }
    .confirm-btn, .delete-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-left: 5px;
    }
    .confirm-btn {
      background: #388e3c;
      color: white;
    }
    .confirm-btn:hover {
      background: #2e7d32;
    }
    .delete-btn {
      background: #f44336;
      color: white;
    }
    .delete-btn:hover {
      background: #d32f2f;
    }
    .no-orders {
      text-align: center;
      color: #888;
      font-style: italic;
      padding: 30px;
    }
    .add-form {
      background: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .add-form input, .add-form select {
      width: 100%;
      padding: 8px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .add-form button {
      width: 100%;
      padding: 10px;
      background: #5d4037;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 10px;
    }
    .export-btn {
      background: #1976d2;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    #manageMenu {
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìã Dashboard Staff</h1>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div>Chiffre d‚Äôaffaires aujourd‚Äôhui</div>
      <div class="stat-value" id="totalSales">0 </div>
    </div>
    <div class="stat-card">
      <div>Commandes valid√©es</div>
      <div class="stat-value" id="ordersCount">0</div>
    </div>
    <button class="export-btn" onclick="exportSalesTxt()">üìÑ Fichiers vente (un) .txt</button>
  </div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="pending">En Attente</button>
    <button class="tab-btn" data-tab="confirmed">Valid√©es</button>
    <button class="tab-btn" data-tab="add">Ajouter/Supprimer</button>
  </div>

  <div id="pendingTab" class="tab-content active">
    <h2>üì¶ Commandes en Attente</h2>
    <div id="pendingOrders">
      <div class="no-orders">Chargement‚Ä¶</div>
    </div>
  </div>

  <div id="confirmedTab" class="tab-content">
    <h2>‚úÖ Commandes Valid√©es</h2>
    <div id="confirmedOrders">
      <div class="no-orders">Chargement‚Ä¶</div>
    </div>
  </div>

  <div id="addTab" class="tab-content">
    <h2>‚ûï Ajouter un plat au menu</h2>
    <div class="add-form">
      <input type="text" id="itemName" placeholder="Nom du plat" required />
      <input type="text" id="itemDesc" placeholder="Description" required />
      <select id="itemCategory">
        <option value="entrees">Entr√©es</option>
        <option value="plats">Plats</option>
        <option value="desserts">Desserts</option>
        <option value="boissons">Boissons</option>
      </select>
      <input type="text" id="itemPrice" placeholder="Prix (ex: 18)" required />
      
      <label for="itemImageUpload">Choisir une image :</label>
      <input type="file" id="itemImageUpload" accept="image/*" onchange="previewImage(event)" />
      <div id="imagePreview" style="margin:10px; text-align:center;">
        <img id="preview" src="" alt="Aper√ßu" style="max-width:100%; max-height:150px; display:none;" />
      </div>

      <button onclick="addMenuItem()">Ajouter le plat</button>
    </div>

    <h2 style="margin-top: 30px;">üóëÔ∏è G√©rer les plats</h2>
    <div id="manageMenu">
      <p>Chargement‚Ä¶</p>
    </div>
  </div>

  <script>
    // ‚úÖ Lire le token depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    const restaurantId = urlParams.get('token');

    if (!restaurantId || !restaurantId.startsWith('rest_')) {
      alert("‚ùå Lien invalide. Veuillez utiliser le lien fourni.");
      throw new Error("restaurant_id manquant");
    }

    // ‚úÖ CORRIG√â : pas d'espace √† la fin !
    const BASE_URL = 'https://web-production-8ff71.up.railway.app';

    // === Fonctions ===
    function previewImage(event) {
      const input = event.target;
      const preview = document.getElementById('preview');
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
        preview.style.display = 'block';
      };
      if (input.files?.[0]) reader.readAsDataURL(input.files[0]);
    }

    async function addMenuItem() {
      const name = document.getElementById('itemName').value.trim();
      const desc = document.getElementById('itemDesc').value.trim();
      const category = document.getElementById('itemCategory').value;
      const price = document.getElementById('itemPrice').value.trim();
      const imageFile = document.getElementById('itemImageUpload').files[0];

      if (!name || !desc || !category || !price) {
        alert("Veuillez remplir tous les champs.");
        return;
      }
      if (!imageFile) {
        alert("Veuillez s√©lectionner une image.");
        return;
      }

      // ‚úÖ Cr√©er un FormData pour envoyer l'image comme fichier
      const formData = new FormData();
      formData.append('name', name);
      formData.append('description', desc);
      formData.append('category', category);
      formData.append('price', price);
      formData.append('image_data', imageFile); // ‚Üê Envoie le fichier, pas le Base64

      try {
        const response = await fetch(`${BASE_URL}/api/menu/add/${restaurantId}`, {
          method: 'POST',
          body: formData
        });

        if (response.ok) {
          alert("‚úÖ Plat ajout√© !");
          // R√©initialiser le formulaire
          document.getElementById('itemName').value = '';
          document.getElementById('itemDesc').value = '';
          document.getElementById('itemPrice').value = '';
          document.getElementById('itemImageUpload').value = '';
          document.getElementById('preview').style.display = 'none';
          loadMenuForManagement();
        } else {
          const err = await response.json();
          alert("‚ùå " + (err.error || "Erreur inconnue"));
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Erreur r√©seau. V√©rifiez votre connexion.");
      }
    }

    async function loadMenuForManagement() {
      try {
        const response = await fetch(`${BASE_URL}/api/menu/${restaurantId}`);
        const items = await response.json();
        const container = document.getElementById('manageMenu');

        if (items.length === 0) {
          container.innerHTML = '<p>Aucun plat dans le menu.</p>';
        } else {
          container.innerHTML = `
            <div style="display: grid; gap: 10px; max-height: 300px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 8px;">
              ${items.map(item => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee;">
                  <div><strong>${item.name}</strong> ‚Äî ${item.category}</div>
                  <button class="delete-btn" onclick="deleteMenuItem(${item.id})">Supprimer</button>
                </div>
              `).join('')}
            </div>
          `;
        }
      } catch (err) {
        console.error(err);
        document.getElementById('manageMenu').innerHTML = '<p style="color:red;">‚ùå Erreur de chargement.</p>';
      }
    }

    async function deleteMenuItem(itemId) {
      if (!confirm("‚ö†Ô∏è Supprimer ce plat ? Cette action est irr√©versible.")) return;

      try {
        const response = await fetch(`${BASE_URL}/api/menu/${itemId}`, { method: 'DELETE' });
        if (response.ok) {
          alert("‚úÖ Plat supprim√© !");
          loadMenuForManagement();
        } else {
          const err = await response.json();
          alert("‚ùå " + (err.error || "Impossible de supprimer."));
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Erreur r√©seau.");
      }
    }

    // ‚úÖ CORRIG√â : on NE parse PAS order.items ‚Üí il vient d√©j√† structur√© du backend !
    async function loadOrders(url, containerId) {
      const container = document.getElementById(containerId);
      try {
        const response = await fetch(url);
        const orders = await response.json();

        if (orders.length === 0) {
          container.innerHTML = '<div class="no-orders">Aucune commande.</div>';
          return;
        }

        container.innerHTML = orders.map(order => `
          <div class="order-card">
            <div class="order-header">
              <span class="order-table">Table ${order.table_number}</span>
              ${url.includes('pending') ? 
                `<button class="confirm-btn" onclick="confirmOrder(${order.id})">‚úì Valider</button>` : 
                `<div style="display: flex; gap: 5px;">
                   <small style="color:green;">‚úÖ Valid√©e</small>
                   <button class="delete-btn" onclick="deleteOrder(${order.id})">üóëÔ∏è Supprimer</button>
                 </div>`
              }
            </div>
            <div class="order-items">
              ${order.items.map(item => `${item.name} (${item.price})`).join(', ')}
            </div>
            <small>Envoy√©e √† ${new Date(order.timestamp).toLocaleTimeString()}</small>
          </div>
        `).join('');
      } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="no-orders" style="color:red;">‚ùå Erreur serveur.</div>';
      }
    }

    async function confirmOrder(orderId) {
      try {
        const response = await fetch(`${BASE_URL}/api/order/${orderId}/confirm`, { method: 'POST' });
        if (response.ok) {
          await Promise.all([
            loadOrders(`${BASE_URL}/api/orders/pending/${restaurantId}`, 'pendingOrders'),
            loadOrders(`${BASE_URL}/api/orders/confirmed/${restaurantId}`, 'confirmedOrders'),
            loadStats()
          ]);
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Erreur de confirmation.");
      }
    }

    async function deleteOrder(orderId) {
      if (!confirm("‚ö†Ô∏è Supprimer cette commande ?")) return;
      try {
        const response = await fetch(`${BASE_URL}/api/order/${orderId}`, { method: 'DELETE' });
        if (response.ok) {
          await Promise.all([
            loadOrders(`${BASE_URL}/api/orders/pending/${restaurantId}`, 'pendingOrders'),
            loadOrders(`${BASE_URL}/api/orders/confirmed/${restaurantId}`, 'confirmedOrders'),
            loadStats()
          ]);
        }
      } catch (err) {
        console.error(err);
        alert("‚ùå Erreur de suppression.");
      }
    }

    function exportSalesTxt() {
      fetch(`${BASE_URL}/api/orders/confirmed/${restaurantId}`)
        .then(res => res.json())
        .then(orders => {
          const today = new Date().toISOString().split('T')[0];
          const todayOrders = orders.filter(order => order.timestamp.startsWith(today));

          if (todayOrders.length === 0) {
            alert("Aucune vente aujourd'hui.");
            return;
          }

          let content = "=== VENTES DU JOUR ===\n\n";
          todayOrders.forEach(order => {
            const itemsStr = order.items.map(item => `${item.name} (${item.price})`).join(', ');
            content += `Table ${order.table_number}: ${itemsStr} ‚Äî Total: ${order.total_price} \n`;
          });

          const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `ventes_${today}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(a.href);
          alert(`‚úÖ Fichier "ventes_${today}.txt" t√©l√©charg√©.`);
        })
        .catch(err => {
          console.error(err);
          alert("‚ùå Erreur d'export.");
        });
    }

    async function loadStats() {
      try {
        const response = await fetch(`${BASE_URL}/api/stats/today/${restaurantId}`);
        const stats = await response.json();
        document.getElementById('totalSales').textContent = `${Math.round(stats.total_sales * 100) / 100 || 0} `;
        document.getElementById('ordersCount').textContent = stats.orders_count || 0;
      } catch (err) {
        console.error(err);
      }
    }

    // === Gestion des onglets ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`${btn.dataset.tab}Tab`).classList.add('active');

        if (btn.dataset.tab === 'pending') {
          loadOrders(`${BASE_URL}/api/orders/pending/${restaurantId}`, 'pendingOrders');
        } else if (btn.dataset.tab === 'confirmed') {
          loadOrders(`${BASE_URL}/api/orders/confirmed/${restaurantId}`, 'confirmedOrders');
        } else if (btn.dataset.tab === 'add') {
          loadMenuForManagement();
        }
      });
    });

    // Chargement initial
    loadOrders(`${BASE_URL}/api/orders/pending/${restaurantId}`, 'pendingOrders');
    loadOrders(`${BASE_URL}/api/orders/confirmed/${restaurantId}`, 'confirmedOrders');
    loadStats();

    // Rafra√Æchissement auto
    setInterval(() => {
      loadOrders(`${BASE_URL}/api/orders/pending/${restaurantId}`, 'pendingOrders');
      loadOrders(`${BASE_URL}/api/orders/confirmed/${restaurantId}`, 'confirmedOrders');
      loadStats();
    }, 5000);
  </script>
</body>
</html>